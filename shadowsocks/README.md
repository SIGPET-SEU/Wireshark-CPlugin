# Wireshark Dissector for Shadowsocks

## Reference

- [shadowsocks-libev](https://github.com/shadowsocks/shadowsocks-libev)
- [Xray-core](https://github.com/XTLS/Xray-core)
- Clash

The implementations of some functions in [`packet-shadowsocks.c`](./packet-shadowsocks.c) (especially those related to AEAD) are directly modified from the source code of [shadowsocks-libev](https://github.com/shadowsocks/shadowsocks-libev).

Clash and Xray-core are mainly used as proxy clients to generate Shadowsocks traffic for testing. The source code of these tools are modified in the testing process to record necessary debugging information.

## Usage

### 1. Compile with Wireshark

Obtain the **source code** and setup **environment** for compiling Wireshark.

Place current directory under `plugins/epan/`, add it to the `CMakeListsCustom.txt` file, and build Wireshark.

*See Wireshark Developer's Guide - [Chapter 2](https://www.wireshark.org/docs/wsdg_html_chunked/ChapterSetup.html) and [Chapter 3](https://www.wireshark.org/docs/wsdg_html_chunked/ChapterSources.html) for more instructions.*

### 2. Capture Traffic OR Use Existing Capture File

Whichever way you choose, it is necessary to know the configuration of the target Shadowsocks server, including the **cipher**, **password**, and the **port number**.

### 3. Set Protocol Preferences

`Edit` -> `Preference` -> `Protocols` -> `Shadowsocks` ->

- **Cipher:** The AEAD method used by the Shadowsocks server. Possible values are:
  - aes-128-gcm
  - aes-192-gcm
  - aes-256-gcm
  - chacha20-ietf-poly1305
  - ~~xchacha20-ietf-poly1305~~
- **Password:** The password set by the Shadowsocks server.
- **Shadowsocks TCP port:** The port number that the Shadowsocks server listens on.

## Known Issues

### 1. Incomplete Capture Files

If a capture file is not complete (e.g., the first packet containing client's salt is missing), the dissector may not work properly.

### 2. Dissector Bugs

> ** (wireshark:2963) 00:41:26.146341 [Epan WARNING] -- Dissector bug, protocol Shadowsocks, in packet 10423: epan/reassemble.c:3481: failed assertion "!((pinfo)->fd->visited) && datalen == length"

Warning message like this may appear when dissecting Complicated Shadowsocks traffic generated by browsers.

It usually happens when **a TCP packet contains 3 segments of Shadowsocks packets** (the tail of \#N, the whole \#N+1, and the head of \#N+2).

## To Do

- [ ] Handle the incomplete capture file
- [ ] Dissection of Shadowsocks UDP packets
- [ ] Add support for other encryption methods that [Xray-core supports](https://xtls.github.io/config/inbounds/shadowsocks.html#supported-encryption-methods)
- [ ] More convenient way to configure the protocol preferences

## Cross-Platform

The dissector is tested on **Linux**, **MacOS**, and **Windows**.
